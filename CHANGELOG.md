# 변경 이력 (Changelog)

## v3.0 - 2025-11-22

### 🎯 주요 변경사항

#### 1. OFF.md 오프제도 완전 폐지
- **제거된 기능:**
  - OFF.md 파일 기반 오프 선언 시스템
  - 주간 오프 한도 검증 (주 3회 제한)
  - 초과 오프 자동 결석 전환

- **제거된 함수:**
  - `OFF파일확인()` - OFF.md 파일 존재 확인
  - `주간오프검증()` - 주간 오프 한도 검증
  - `getISOYearWeek()` - ISO 주차 계산
  - `과거주차_전체재검증()` - 과거 오프 재검증

- **제거된 CONFIG:**
  - `OFF_FILENAME: 'OFF.md'`
  - `MAX_OFF_PER_WEEK: 3`
  - `MIN_ATTENDANCE_PER_WEEK: 4`

- **하위 호환성:**
  - 기존 OFF 상태 기록은 그대로 표시됨
  - JSON 생성 시 기존 OFF 데이터 처리 유지

#### 2. 새로운 주간 집계 시스템 (방안 4: 월요일 기준)
- **파일:** `weekly-attendance.gs`
- **핵심 로직:**
  - 주 = 월요일 ~ 일요일 (7일)
  - 주가 속한 월 = **월요일이 속한 월**
  - 매주 4회 인증 필요
  - 장기오프 일수만큼 필요 횟수 차감
  - 전체 주가 장기오프(7일)면 결석 0

- **주요 함수:**
  - `월별주목록가져오기(year, month)` - 해당 월의 모든 주 목록 반환
  - `주간인증계산(memberName, 주시작, 주끝)` - 주간 인증 횟수 및 결석 계산
  - `월별주간집계(year, month)` - 월별 주간 집계 실행
  - `주간집계저장(year, month, 집계결과)` - 결과를 '주간집계' 시트에 저장
  - `이번달주간집계()` - 수동 실행용 함수

- **결석 계산 로직:**
  ```
  필요횟수 = 4 - 장기오프일수
  부족 = 필요횟수 - 인증횟수

  부족 1회 → 결석 1회
  부족 2회 → 결석 2회
  부족 3회 → 결석 3회
  부족 4회 이상 → 결석 4회
  ```

#### 3. Gemini AI 통합
- **파일:** `gemini-ai.gs`
- **기능:**
  - 조원별 공부 내용 자동 요약
  - 학습 질 평가 (1-10점)
  - 핵심 키워드 추출
  - 통합 다이제스트 생성

- **주요 함수:**
  - `GeminiAPI호출(prompt)` - Gemini API 요청
  - `AI개별요약및평가(memberName, 내용, 파일목록)` - 개인별 AI 분석
  - `AI통합다이제스트생성(조원데이터, dateStr)` - 전체 조원 통합 요약
  - `일일AI다이제스트생성(dateStr)` - 메인 실행 함수
  - `파일내용수집(memberName, folderId, dateStr)` - 파일 내용 수집

- **AI 평가 기준:**
  - 10점: 매우 심도있는 학습, 체계적 정리, 응용/분석 포함
  - 7-9점: 충실한 학습, 핵심 개념 정리
  - 4-6점: 기본적 학습, 단순 암기 위주
  - 1-3점: 매우 형식적이거나 내용 빈약

- **API 키 설정:**
  - 프로젝트 설정 > 스크립트 속성 > `GEMINI_API_KEY` 추가
  - `GEMINI_CONFIG.getApiKey()`로 안전하게 로드

#### 4. 기존 시스템 업데이트
- **apps script code.gs**
  - 버전: v2.2 → **v3.0**
  - 헤더 주석 업데이트 (새로운 기능 설명)
  - OFF.md 체크 로직 제거
  - 주간오프검증() 호출 제거
  - 장기오프 시스템 유지

- **digest-functions.gs**
  - OFF.md 체크 로직 제거 (line 101-106)
  - OFF 상태 표시는 하위 호환성을 위해 유지

### 📋 다음 작업 (Pending)

#### 1. 출석표 HTML 업데이트
- [ ] 주간 통계 표시 섹션 추가
- [ ] 일간 출석 + 주간 집계 통합 뷰
- [ ] 주차별 인증 횟수, 필요 횟수, 결석 표시
- [ ] 장기오프 일수 표시

#### 2. AI 다이제스트 통합
- [ ] digest-page.html - AI 요약 및 질 평가 표시
- [ ] copy-page.html - AI 다이제스트 텍스트 통합
- [ ] 자동 생성 트리거 설정

#### 3. 시스템 테스트
- [ ] 주간 집계 로직 테스트
- [ ] AI API 통합 테스트
- [ ] 월 경계 주차 테스트
- [ ] 장기오프 차감 로직 테스트

#### 4. 문서화
- [ ] 설치 가이드 업데이트
- [ ] API 키 설정 가이드
- [ ] 주간 집계 사용법

### 🔧 설정 방법

#### Gemini API 키 설정
1. Apps Script 편집기 열기
2. 왼쪽 메뉴 > 프로젝트 설정 (⚙️)
3. "스크립트 속성" 탭
4. "스크립트 속성 추가" 클릭
5. 속성: `GEMINI_API_KEY`
6. 값: [발급받은 Gemini API 키]
7. 저장

#### 주간 집계 트리거 설정
1. Apps Script 편집기 > 트리거 (시계 아이콘)
2. "+ 트리거 추가" 클릭
3. 함수: `이번달주간집계`
4. 이벤트 소스: 시간 기반
5. 시간 간격: 일 타이머
6. 시간: 오전 0시 ~ 1시 (또는 원하는 시간)
7. 저장

### ⚠️ 주의사항

#### 데이터 마이그레이션
- 기존 OFF.md 파일은 자동으로 무시됨
- 기존 OFF 상태 기록은 표시는 되지만 새로 생성 불가
- 주간 집계는 월요일 기준이므로 월 초에 전월 주차가 포함될 수 있음

#### API 사용량
- Gemini API 무료 한도 확인 필요
- 일일 조원 수 × API 호출 ≈ 매일 10-15회
- 통합 다이제스트 추가 1회
- 월 300-500회 예상

### 📊 데이터 구조 변경

#### 주간집계 시트 (신규)
```
년월 | 조원명 | 주차 | 인증 | 필요 | 장기오프일 | 결석 | 비고
-----|--------|------|------|------|------------|------|------
2025-11 | 센트룸 | 1 | 4 | 4 | 0 | 0 |
2025-11 | 센트룸 | 2 | 3 | 4 | 0 | 1 |
```

#### AI 다이제스트 JSON (신규)
```json
{
  "date": "2025-11-22",
  "generated": "2025-11-22T20:00:00.000Z",
  "summary": "📚 오늘의 스터디 다이제스트...",
  "members": [
    {
      "name": "센트룸",
      "summary": "AI 생성 요약...",
      "keywords": "한의학, 경혈, 치료",
      "qualityScore": 8,
      "qualityComment": "충실한 학습...",
      "files": [...]
    }
  ]
}
```

### 🐛 알려진 이슈
- 없음

### 👥 기여자
- Claude (Anthropic) - 코드 생성 및 시스템 설계
