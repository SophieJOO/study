# 안전한 배포 가이드

## ⚠️ 배포 전 필수 체크리스트

### 1. 백업 (필수!)

#### Google Sheets 백업
```
1. 현재 스프레드시트 열기
2. 파일 > 사본 만들기
3. 이름: "스터디 출석 백업 - 2025-11-22"
4. 저장 위치 확인
```

#### Apps Script 코드 백업
```
1. Apps Script 편집기 열기
2. 각 .gs 파일 내용 복사
3. 로컬에 저장 또는 별도 스크립트 프로젝트 생성
```

**백업해야 할 파일:**
- `apps script code.gs` (기존 메인 코드)
- `index (1).html` (출석표)
- 기타 커스텀 파일들

### 2. 테스트 환경 구성 (강력 권장)

#### 옵션 A: 테스트 스프레드시트 생성
```
1. 현재 스프레드시트 복사
2. "스터디 출석 TEST" 이름으로 저장
3. 테스트 시트에 새 코드 배포
4. 1주일 병렬 운영하며 검증
```

#### 옵션 B: 새 기능만 먼저 테스트
```
1. 기존 코드는 그대로 유지
2. weekly-attendance.gs, gemini-ai.gs만 추가
3. 수동 실행으로 테스트
4. 검증 후 메인 코드 교체
```

### 3. 단계적 배포 (가장 안전)

#### Phase 1: 독립 기능 추가 (안전)
```
✅ weekly-attendance.gs 추가
✅ gemini-ai.gs 추가
✅ 수동 실행으로 테스트

위험도: 낮음 (기존 시스템 영향 없음)
```

#### Phase 2: 검증 (1주일)
```
✅ 주간 집계 결과 확인
✅ AI 다이제스트 품질 확인
✅ 기존 출석 체크와 비교

위험도: 없음 (읽기만 수행)
```

#### Phase 3: 메인 코드 교체 (신중)
```
⚠️ apps script code.gs 교체
⚠️ OFF.md 제도 폐지 적용
⚠️ digest-functions.gs 업데이트

위험도: 중간 (백업 필수)
```

## 🔄 롤백 방법

### 즉시 롤백 (문제 발생 시)

#### 1. Apps Script 코드 롤백
```
1. Apps Script 편집기 열기
2. 파일 > 버전 기록
3. 이전 버전 선택
4. "복원" 클릭
```

#### 2. 스프레드시트 롤백
```
1. 백업 스프레드시트 열기
2. 데이터 복사
3. 원본에 붙여넣기
```

#### 3. Git 롤백 (코드만)
```bash
# 이전 커밋으로 돌아가기
git checkout 8276cba  # v2.2 버전

# 새 브랜치 생성
git checkout -b rollback-safety
```

## 📊 데이터 호환성 확인

### 기존 데이터 영향 분석

| 데이터 유형 | 영향 | 비고 |
|------------|------|------|
| 기존 OFF 레코드 | ✅ 안전 | 표시/카운트 유지 |
| 기존 출석 레코드 | ✅ 안전 | 영향 없음 |
| 기존 장기오프 | ✅ 안전 | 시스템 유지 |
| JSON 파일 | ✅ 안전 | 호환성 유지 |
| HTML 출석표 | ✅ 안전 | 기존 데이터 표시 |

### 새로운 동작

| 상황 | 기존 동작 | 새 동작 |
|------|----------|---------|
| OFF.md 파일 업로드 | OFF 상태 기록 | 무시 (파일 없음 처리) |
| 주간 OFF 4회 | 초과분 결석 전환 | 체크 없음 |
| 장기오프 | 인정 | 인정 (변경 없음) |

## 🧪 테스트 시나리오

### 필수 테스트

#### 1. 기존 데이터 읽기 테스트
```javascript
// Apps Script에서 실행
function 기존데이터확인() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('제출기록');
  const data = sheet.getDataRange().getValues();

  let offCount = 0;
  let attendanceCount = 0;

  for (let i = 1; i < data.length; i++) {
    const status = data[i][6]; // 7번째 열: 상태
    if (status === 'OFF') offCount++;
    if (status === 'O') attendanceCount++;
  }

  Logger.log(`기존 OFF 레코드: ${offCount}개`);
  Logger.log(`기존 출석 레코드: ${attendanceCount}개`);
  Logger.log('✅ 데이터 읽기 정상');
}
```

#### 2. 주간 집계 테스트
```javascript
// weekly-attendance.gs에서 실행
function 주간집계테스트() {
  const 결과 = 월별주간집계(2025, 10); // 11월 (0-based)
  Logger.log('주간 집계 결과:', 결과);
  Logger.log('✅ 주간 집계 정상');
}
```

#### 3. AI 테스트 (API 키 설정 후)
```javascript
// gemini-ai.gs에서 실행
function AI테스트() {
  try {
    const today = Utilities.formatDate(new Date(), 'Asia/Seoul', 'yyyy-MM-dd');
    일일AI다이제스트생성(today);
    Logger.log('✅ AI 통합 정상');
  } catch (e) {
    Logger.log('❌ AI 오류:', e.message);
  }
}
```

## 🚨 문제 발생 시 대응

### 시나리오 1: 출석 체크가 작동하지 않음
**증상:** 새로운 출석이 기록되지 않음
**원인:** 코드 오류 또는 권한 문제
**해결:**
```
1. 즉시 백업 코드로 롤백
2. 로그 확인: Apps Script > 실행 로그
3. 권한 재승인: 초기설정() 실행
```

### 시나리오 2: 기존 데이터가 사라짐
**증상:** 출석표에 데이터가 안 보임
**원인:** 시트 이름 변경 또는 데이터 삭제
**해결:**
```
1. 백업 스프레드시트에서 데이터 복원
2. 시트 이름 확인: CONFIG.SHEET_NAME
3. JSON 파일에서 복원 가능
```

### 시나리오 3: AI가 작동하지 않음
**증상:** AI 다이제스트 생성 실패
**원인:** API 키 미설정 또는 할당량 초과
**해결:**
```
1. API 키 확인: GEMINI_API_KEY 설정 여부
2. 할당량 확인: Google AI Studio
3. 임시로 AI 기능 비활성화 (선택적)
```

## ✅ 안전 배포 체크리스트

배포 전 체크:
- [ ] 백업 완료 (스프레드시트 + 코드)
- [ ] 테스트 환경 준비
- [ ] 롤백 방법 숙지
- [ ] API 키 준비 (Gemini)

배포 중 체크:
- [ ] 기존데이터확인() 실행 → 정상
- [ ] 주간집계테스트() 실행 → 정상
- [ ] AI테스트() 실행 → 정상 (선택)

배포 후 체크 (1주일):
- [ ] 매일 출석 체크 정상 작동
- [ ] 기존 데이터 표시 정상
- [ ] 주간 집계 정확성 확인
- [ ] JSON 파일 생성 정상

## 📞 문제 발생 시

1. **즉시 롤백**: 백업으로 복원
2. **로그 확인**: Apps Script > 실행 > 로그 보기
3. **데이터 확인**: 제출기록 시트 직접 확인
4. **Git 커밋 확인**: 이전 버전 확인

## 🎯 권장 배포 전략

### 🥇 최고 안전: 테스트 환경 1주일
```
1. 스프레드시트 복사본 생성
2. 복사본에 새 코드 배포
3. 1주일 병렬 운영
4. 검증 후 원본에 적용
```

### 🥈 중간 안전: 단계적 배포
```
1. 백업 생성
2. 새 기능만 추가 (weekly, gemini)
3. 수동 실행으로 검증
4. 1주 후 메인 코드 교체
```

### 🥉 빠른 배포: 백업 후 즉시 적용
```
1. 백업 생성
2. 모든 코드 교체
3. 테스트 실행
4. 문제 시 즉시 롤백
```

---

**중요:** OFF.md 제도를 계속 사용하고 싶으시면 apps script code.gs를 교체하지 마세요!
